<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word War GRE</title>
    <!-- Tailwind CSS CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font for retro pixelated look -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #000; /* Deep black for arcade feel */
            color: #E0E0E0; /* Light grey for text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem; /* Responsive padding */
            box-sizing: border-box;
            overflow: hidden; /* Prevent scrollbars */
            background-image:
                linear-gradient(rgba(0, 255, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px; /* Subtle green grid */
        }

        /* Scanline effect for retro display */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.25) 50%), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 2px, 2px 100%;
            pointer-events: none; /* Allow clicks through */
            z-index: 1000; /* Ensure it's on top */
        }


        .game-container {
            background-color: #0F0F0F; /* Dark grey for console */
            border: 8px solid #00FF00; /* Neon green border */
            border-radius: 15px;
            padding: 1.5rem; /* Responsive padding */
            box-shadow:
                0 0 30px #00FF00, /* Stronger neon green glow */
                0 0 60px #FF00FF, /* Vibrant magenta secondary glow */
                inset 0 0 20px rgba(255, 255, 255, 0.3); /* Inner highlight */
            max-width: 95%; /* Responsive max-width */
            width: 100%; /* Take full width on smaller screens */
            max-width: 900px; /* Limit max width on large screens */
            text-align: center;
            position: relative;
            animation: pulse-border 1.5s infinite alternate; /* Faster pulse */
        }

        @keyframes pulse-border {
            from {
                border-color: #00FF00;
                box-shadow: 0 0 30px #00FF00, 0 0 60px #FF00FF, inset 0 0 20px rgba(255, 255, 255, 0.3);
            }
            to {
                border-color: #00FFFF; /* Aqua */
                box-shadow: 0 0 40px #00FFFF, 0 0 80px #FFFF00, inset 0 0 25px rgba(255, 255, 255, 0.4); /* Yellow */
            }
        }

        h1 {
            color: #FFFF00; /* Bright yellow */
            text-shadow: 4px 4px #FF00FF; /* Magenta shadow */
            font-size: 2.5rem; /* Base font size */
            margin-bottom: 1.5rem; /* Responsive margin */
            text-transform: uppercase;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            h1 { font-size: 3rem; }
        }
        @media (min-width: 768px) { /* md breakpoint */
            h1 { font-size: 3.5rem; }
        }

        h2 {
            color: #00FF00; /* Bright green */
            text-shadow: 2px 2px #00FFFF; /* Aqua shadow */
            font-size: 2rem; /* Base font size */
            margin-bottom: 1.25rem; /* Responsive margin */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            h2 { font-size: 2.25rem; }
        }
        @media (min-width: 768px) { /* md breakpoint */
            h2 { font-size: 2.5rem; }
        }

        button {
            background-color: #FF00FF; /* Magenta */
            color: #FFFFFF;
            padding: 1rem 1.5rem; /* Responsive padding */
            border: 5px solid #00FF00; /* Neon green border */
            border-radius: 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem; /* Base font size */
            cursor: pointer;
            transition: all 0.1s ease-in-out;
            text-shadow: 2px 2px #000;
            box-shadow: 0 8px #8B008B; /* Darker purple shadow for depth */
            /* Removed fixed margins here to use flexbox gap */
            outline: none;
            position: relative;
            top: 0;
            left: 0;
            letter-spacing: 1px;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            button { padding: 1.125rem 2rem; font-size: 1.125rem; }
        }
        @media (min-width: 768px) { /* md breakpoint */
            button { padding: 1.25rem 2.5rem; font-size: 1.25rem; }
        }


        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Game specific styles */
        #score-display, #wrong-attempts-display {
            font-size: 1.5rem; /* Base font size */
            margin: 0.75rem 0; /* Responsive margin */
            color: #FFFF00; /* Yellow */
            text-shadow: 2px 2px #000;
        }
        @media (min-width: 640px) {
            #score-display, #wrong-attempts-display { font-size: 1.8rem; }
        }

        #wrong-attempts-display {
            color: #FF0000; /* Bright red */
        }

        #word-display {
            font-size: 2rem; /* Default for smaller screens like tablets */
            font-weight: bold;
            color: #FFFFFF; /* White for clarity */
            margin-bottom: 2rem; /* Responsive margin */
            text-shadow: 0 0 10px #4B0082, 0 0 20px #4B0082; /* Dark purple glow */
            word-wrap: break-word;
            transition: color 0.1s ease-in-out, text-shadow 0.1s ease-in-out;
            min-height: 4rem; /* Ensure space for feedback */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* Add padding for long words */
        }
        @media (max-width: 480px) { /* Extra small phones */
            #word-display { font-size: 1.75rem; min-height: 3.5rem; } /* Made smaller for tiny screens */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            #word-display { font-size: 2.5rem; min-height: 5rem; }
        }
        @media (min-width: 768px) { /* md breakpoint */
            #word-display { font-size: 2.8rem; min-height: 5rem; }
        }


        #word-display.correct-feedback {
            color: #00FF00; /* Bright green */
            text-shadow: 0 0 15px #00FF00, 0 0 30px #00FF00;
        }

        #word-display.wrong-feedback {
            color: #FF0000; /* Bright red */
            text-shadow: 0 0 15px #FF0000, 0 0 30px #FF0000;
        }

        .choices-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem; /* Responsive gap */
            margin-top: 1.5rem; /* Responsive margin */
        }

        @media (min-width: 640px) {
            .choices-grid {
                grid-template-columns: 1fr 1fr;
                gap: 1.25rem; /* Increased gap for larger screens */
            }
        }

        .choice-button {
            background-color: #0000FF; /* Electric blue */
            border: 5px solid #FFFF00; /* Yellow border */
            color: #FFFFFF;
            padding: 1rem; /* Responsive padding */
            border-radius: 10px;
            font-size: 0.9rem; /* Base font size */
            text-align: left;
            word-wrap: break-word;
            min-height: 5rem; /* Taller buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px #0000A0; /* Darker blue shadow */
        }
        @media (min-width: 640px) {
            .choice-button { font-size: 1rem; padding: 1.25rem; min-height: 6rem; }
        }
        @media (min-width: 768px) {
            .choice-button { font-size: 1.1rem; padding: 1.25rem; min-height: 6.25rem; }
        }


        .choice-button:hover {
            background-color: #00FFFF; /* Aqua on hover */
            border-color: #FF00FF; /* Magenta border on hover */
            box-shadow: 0 8px #008B8B; /* Darker aqua shadow */
        }

        #leaderboard-table {
            width: 100%;
            margin-top: 2rem; /* Responsive margin */
            border-collapse: collapse;
            font-size: 1rem; /* Base font size */
        }
        @media (min-width: 640px) {
            #leaderboard-table { font-size: 1.1rem; }
        }
        @media (min-width: 768px) {
            #leaderboard-table { font-size: 1.2rem; }
        }


        #leaderboard-table th, #leaderboard-table td {
            border: 3px solid #00FF00; /* Neon green border */
            padding: 0.75rem; /* Responsive padding */
            text-align: left;
            color: #E0E0E0;
        }
        @media (min-width: 640px) {
            #leaderboard-table th, #leaderboard-table td { padding: 1rem; }
        }


        #leaderboard-table th {
            background-color: #0000FF; /* Electric blue header */
            color: #FFFF00;
            text-shadow: 1px 1px #000;
        }

        #leaderboard-table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.3);
        }

        input[type="text"] {
            background-color: #1A1A1A; /* Dark background */
            border: 3px solid #00FF00; /* Neon green border */
            color: #FFFF00;
            font-family: 'Press Start 2P', cursive;
            padding: 0.75rem; /* Responsive padding */
            font-size: 1rem; /* Base font size */
            border-radius: 8px;
            width: calc(100% - 1.5rem); /* Adjust for padding/border */
            max-width: 350px;
            margin-top: 1rem; /* Responsive margin */
            text-align: center;
        }
        @media (min-width: 640px) {
            input[type="text"] { padding: 1rem; font-size: 1.1rem; }
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #FF00FF;
            box-shadow: 0 0 15px #FF00FF;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .modal-content {
            background-color: #0F0F0F;
            border: 8px solid #FF00FF; /* Magenta border */
            border-radius: 20px;
            padding: 2.5rem; /* Responsive padding */
            text-align: center;
            box-shadow: 0 0 40px #FF00FF, inset 0 0 20px rgba(255, 255, 255, 0.4);
            max-width: 90%; /* Responsive max-width */
            width: 600px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.1rem; /* Base font size */
            color: #E0E0E0;
            position: relative;
            animation: modal-pop-in 0.3s ease-out;
        }
        @media (min-width: 640px) {
            .modal-content { font-size: 1.2rem; padding: 3rem; }
        }

        .modal-content h3 {
            color: #FFFF00;
            font-size: 1.8rem; /* Base font size */
            margin-bottom: 1.5rem; /* Responsive margin */
            text-shadow: 2px 2px #FF00FF;
        }
        @media (min-width: 640px) {
            .modal-content h3 { font-size: 2.2rem; }
        }

        .modal-content button {
            background-color: #00FF00; /* Green */
            border-color: #FFFF00; /* Yellow */
            margin-top: 2rem; /* Responsive margin */
            padding: 0.75rem 1.5rem; /* Responsive padding */
            font-size: 1rem; /* Base font size */
            box-shadow: 0 6px #008000; /* Darker green */
        }
        @media (min-width: 640px) {
            .modal-content button { padding: 1rem 2rem; font-size: 1.2rem; }
        }

        .modal-content button:hover {
            background-color: #FFFF00; /* Yellow */
            border-color: #00FF00; /* Green */
            color: #000;
        }

        /* Responsive adjustments for overall layout */
        @media (max-width: 639px) { /* Extra small screens */
            .game-container {
                padding: 1rem;
                border-width: 4px;
                border-radius: 10px;
                box-shadow: 0 0 15px #00FF00, 0 0 30px #FF00FF, inset 0 0 10px rgba(255, 255, 255, 0.2);
            }
            button {
                padding: 0.8rem 1.2rem;
                font-size: 0.9rem;
                border-width: 3px;
                border-radius: 8px;
                box-shadow: 0 4px #8B008B;
                /* No vertical margin here, flexbox will handle it */
                margin: 0; /* Remove horizontal margin as well for full width */
            }
        }
    </style>
</head>
<body>
    <!-- Background Music Placeholder -->
    <audio id="background-music" loop autoplay>
        <!-- IMPORTANT: Ensure this path is correct relative to your index.html file on GitHub! -->
        <!-- If "Run As Fast As You Can.mp3" is in the same folder as index.html, this is correct. -->
        <source src="Run As Fast As You Can.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Sound Effects Placeholders -->
    <audio id="correct-sound">
        <!-- Replace with your public URL or relative path -->
        <source src="correct.mp3" type="audio/mpeg">
        Your browser does not conduct the audio element.
    </audio>
    <audio id="wrong-sound">
        <!-- New error audio file added -->
        <source src="Error - Sound Effect Non copyright sound effe....mp3" type="audio/mpeg">
        Your browser does not conduct the audio element.
    </audio>

    <div class="game-container">
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <h1 class="text-3xl sm:text-4xl md:text-5xl">Word War GRE</h1>
            <p class="text-sm sm:text-base md:text-lg mb-8">Test your GRE vocabulary skills!</p>
            <div class="flex flex-col space-y-4 items-center w-full"> <!-- Added flexbox for buttons -->
                <button id="play-solo-button" class="text-base sm:text-lg md:text-xl w-full max-w-xs">Play Game</button>
                <button id="show-leaderboard-main" class="text-base sm:text-lg md:text-xl w-full max-w-xs">Leaderboard</button>
                <button id="toggle-music-button" class="text-base sm:text-lg md:text-xl w-full max-w-xs">Toggle Music</button>
            </div>
        </div>

        <!-- Game Screen (Solo) -->
        <div id="game-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <div id="score-display" class="text-lg sm:text-xl">Score: 0</div>
                <div id="wrong-attempts-display" class="text-lg sm:text-xl">Wrong: 0/3</div>
            </div>
            <div id="word-display" class="text-2xl sm:text-3xl md:text-4xl mb-8"></div>
            <div id="choices-container" class="choices-grid">
                <!-- Choice buttons will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <h2 class="text-xl sm:text-2xl md:text-3xl">GAME OVER!</h2>
            <p class="text-lg mt-4 mb-4">Your final score: <span id="final-score" class="font-bold text-yellow-400">0</span></p>
            <p class="text-md mb-2">Enter your name for the Leaderboard:</p>
            <input type="text" id="player-name-input" placeholder="Your Name" class="text-sm sm:text-base">
            <button id="save-score-button" class="text-sm sm:text-base mt-4">Save Score</button>
            <button id="play-again-button" class="text-sm sm:text-base">Play Again</button>
            <button id="main-menu-from-gameover" class="text-sm sm:text-base">Main Menu</button>
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboard-screen" class="screen">
            <h2 class="text-xl sm:text-2xl md:text-3xl">Global Leaderboard</h2>
            <div id="leaderboard-loading" class="text-xl text-yellow-400 my-4">Loading Leaderboard...</div>
            <table id="leaderboard-table" class="mx-auto text-sm sm:text-base">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard entries will be injected here by JavaScript -->
                </tbody>
            </table>
            <button id="download-leaderboard-button" class="text-sm sm:text-base mt-8">Download Leaderboard</button>
            <button id="main-menu-from-leaderboard" class="text-sm sm:text-base mt-4">Main Menu</button>
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="custom-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl sm:text-2xl">Attention!</h3>
            <p id="modal-message" class="text-base sm:text-lg"></p>
            <button id="modal-close-button" class="text-sm sm:text-base">OK</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - Copied from your message
        const firebaseConfig = {
            apiKey: "AIzaSyCodVJigrQK0craiXfsbaWi6oJpLZTMKso",
            authDomain: "wordwargre.firebaseapp.com",
            projectId: "wordwargre",
            storageBucket: "wordwargre.firebasestorage.app",
            messagingSenderId: "710867911424",
            appId: "1:710867911424:web:f3703741b9455278e329e5",
            measurementId: "G-TH2KBW28JP"
        };

        // We use the projectId for the artifacts collection path. This ensures it's unique to your project.
        const appIdForCollectionPath = firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose Firebase objects and functions to the global window object
        window.firebaseInitialized = false;
        window.currentUserId = null;
        window.db = db;
        window.auth = auth;
        window.appId = appIdForCollectionPath; // Use the projectId for the collection path
        window.addDoc = addDoc;
        window.collection = collection;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;

        // Authenticate user when Firebase is ready
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase Auth State Changed: User signed in:", user.uid);
            } else {
                console.log("Firebase Auth State Changed: No user signed in. Attempting anonymous sign-in...");
                try {
                    // Try to sign in anonymously if not already signed in
                    await signInAnonymously(auth);
                    window.currentUserId = auth.currentUser.uid;
                    console.log("Firebase: Signed in anonymously. User ID:", window.currentUserId);
                } catch (error) {
                    console.error("Firebase Auth Error during anonymous sign-in:", error);
                    window.showCustomModal("Auth Error", "Could not sign in for leaderboard. Please try refreshing. Check console for details.");
                }
            }
            window.firebaseInitialized = true; // Mark Firebase as ready
            console.log("Firebase: Initialization complete. firebaseInitialized =", window.firebaseInitialized, "currentUserId =", window.currentUserId);

            // Trigger loading of global leaderboard data after Firebase is initialized and user is authenticated
            if (document.getElementById('leaderboard-screen').classList.contains('active') || document.getElementById('main-menu').classList.contains('active')) {
                window.loadGlobalLeaderboard();
            }
        });
    </script>


    <script>
        // Game Data: GRE Words and Definitions
        const words = [
            {
                word: "Acrimonious",
                definition: "Stinging, bitter in temper or tone.",
                options: [
                    "Stinging, bitter in temper or tone.",
                    "Sweet and harmonious.",
                    "Calm and collected.",
                    "Full of joy and laughter."
                ]
            },
            {
                word: "Capricious",
                definition: "Given to sudden and unaccountable changes of mood or behavior.",
                options: [
                    "Given to sudden and unaccountable changes of mood or behavior.",
                    "Stable and predictable.",
                    "Careful and cautious.",
                    "Determined and resolute."
                ]
            },
            {
                word: "Deleterious",
                definition: "Causing harm or damage.",
                options: [
                    "Causing harm or damage.",
                    "Beneficial and helpful.",
                    "Nourishing and healthy.",
                    "Pleasant and enjoyable."
                ]
            },
            {
                word: "Ephemeral",
                definition: "Lasting for a very short time.",
                options: [
                    "Lasting for a very short time.",
                    "Lasting for an eternity.",
                    "Permanent and enduring.",
                    "Slow to change."
                ]
            },
            {
                word: "Fugacious",
                definition: "Fleeting; lasting a short time.",
                options: [
                    "Fleeting; lasting a short time.",
                    "Permanent and unchangeable.",
                    "Strong and durable.",
                    "Moving very slowly."
                ]
            },
            {
                word: "Gregarious",
                definition: "Fond of company; sociable.",
                options: [
                    "Fond of company; sociable.",
                    "Reserved and quiet.",
                    "Solitary and reclusive.",
                    "Shy and introverted."
                ]
            },
            {
                word: "Harangue",
                definition: "A lengthy and aggressive speech.",
                options: [
                    "A lengthy and aggressive speech.",
                    "A brief and polite conversation.",
                    "A gentle whisper.",
                    "A soothing lullaby."
                ]
            },
            {
                word: "Ingenious",
                definition: "Clever, original, and inventive.",
                options: [
                    "Clever, original, and inventive.",
                    "Unimaginative and dull.",
                    "Simple and straightforward.",
                    "Confused and disoriented."
                ]
            },
            {
                word: "Laconic",
                definition: "Using very few words.",
                options: [
                    "Using very few words.",
                    "Talkative and verbose.",
                    "Eloquent and persuasive.",
                    "Loud and boisterous."
                ]
            },
            {
                word: "Mellifluous",
                definition: "Sweet or musical; pleasant to hear.",
                options: [
                    "Sweet or musical; pleasant to hear.",
                    "Harsh and discordant.",
                    "Loud and piercing.",
                    "Rough and abrasive."
                ]
            },
            {
                word: "Obfuscate",
                definition: "Render obscure, unclear, or unintelligible.",
                options: [
                    "Render obscure, unclear, or unintelligible.",
                    "Make clear and understandable.",
                    "Illuminate and enlighten.",
                    "Simplify and clarify."
                ]
            },
            {
                word: "Perfunctory",
                definition: "Carried out with a minimum of effort or reflection.",
                options: [
                    "Carried out with a minimum of effort or reflection.",
                    "Thorough and meticulous.",
                    "Energetic and enthusiastic.",
                    "Careful and precise."
                ]
            },
            {
                word: "Quixotic",
                definition: "Extremely idealistic; unrealistic and impractical.",
                options: [
                    "Extremely idealistic; unrealistic and impractical.",
                    "Realistic and pragmatic.",
                    "Cynical and pessimistic.",
                    "Cautious and conservative."
                ]
            },
            {
                word: "Recalcitrant",
                definition: "Having an obstinately uncooperative attitude toward authority or discipline.",
                options: [
                    "Having an obstinately uncooperative attitude toward authority or discipline.",
                    "Obedient and compliant.",
                    "Eager to cooperate.",
                    "Submissive and docile."
                ]
            },
            {
                word: "Sycophant",
                definition: "A person who acts obsequiously toward someone important in order to gain advantage.",
                options: [
                    "A person who acts obsequiously toward someone important in order to gain advantage.",
                    "An honest and straightforward person.",
                    "A true leader.",
                    "A humble and modest individual."
                ]
            }
        ];

        // Global Game State
        let currentScore = 0;
        let wrongAttempts = 0;
        let currentWord = {};
        let globalLeaderboardData = []; // This will hold scores from Firestore
        let musicPlaying = false; // Track music state

        // DOM Elements
        const mainMenuScreen = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const leaderboardLoading = document.getElementById('leaderboard-loading'); // New loading indicator

        const playSoloButton = document.getElementById('play-solo-button');
        const showLeaderboardMainMenuButton = document.getElementById('show-leaderboard-main');
        const toggleMusicButton = document.getElementById('toggle-music-button');
        const wordDisplay = document.getElementById('word-display');
        const choicesContainer = document.getElementById('choices-container');
        const scoreDisplay = document.getElementById('score-display');
        const wrongAttemptsDisplay = document.getElementById('wrong-attempts-display');
        const finalScoreDisplay = document.getElementById('final-score');
        const playerNameInput = document.getElementById('player-name-input');
        const saveScoreButton = document.getElementById('save-score-button');
        const playAgainButton = document.getElementById('play-again-button');
        const mainMenuFromGameOverButton = document.getElementById('main-menu-from-gameover');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const downloadLeaderboardButton = document.getElementById('download-leaderboard-button');
        const mainMenuFromLeaderboardButton = document.getElementById('main-menu-from-leaderboard');
        const backgroundMusic = document.getElementById('background-music');
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound'); 

        // Custom Modal Elements
        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');


        // --- Utility Functions ---

        // Function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
        }

        // Function to switch between game screens
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            // If going to leaderboard, ensure it's loaded
            if (screenId === 'leaderboard-screen') {
                if (window.firebaseInitialized) {
                    loadGlobalLeaderboard();
                } else {
                    leaderboardBody.innerHTML = '<tr><td colspan="3">Initializing Firebase...</td></tr>';
                    leaderboardLoading.classList.remove('hidden');
                }
            }
        }

        // Function to show custom modal
        window.showCustomModal = function(title, message) { // Made global
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModalOverlay.classList.remove('hidden');
        }

        // Function to hide custom modal
        function hideCustomModal() {
            customModalOverlay.classList.add('hidden');
        }

        // --- Game Logic ---

        // Initializes the game state and displays a new word
        function startGame() {
            currentScore = 0;
            wrongAttempts = 0;
            updateScoreDisplay();
            showScreen('game-screen');
            pickAndDisplayWord();
        }

        // Updates the score and wrong attempts display
        function updateScoreDisplay() {
            scoreDisplay.textContent = `Score: ${currentScore}`;
            wrongAttemptsDisplay.textContent = `Wrong: ${wrongAttempts}/3`;
        }

        // Selects a random word and prepares its options
        function pickAndDisplayWord() {
            const randomIndex = Math.floor(Math.random() * words.length);
            currentWord = { ...words[randomIndex] }; // Clone to avoid modifying original

            // Create choices: correct definition + 3 random incorrect definitions
            let allDefinitions = words.map(w => w.definition);
            // Filter out the correct definition to pick distractors from others
            let incorrectDefinitions = allDefinitions.filter(def => def !== currentWord.definition);

            // Ensure we have enough unique incorrect definitions
            while (incorrectDefinitions.length < 3) {
                const randomOtherDefinition = words[Math.floor(Math.random() * words.length)].definition;
                if (!incorrectDefinitions.includes(randomOtherDefinition) && randomOtherDefinition !== currentWord.definition) {
                    incorrectDefinitions.push(randomOtherDefinition);
                } else if (words.length <= 4) { // Fallback for very small word lists
                    incorrectDefinitions.push(`A different meaning ${Math.random().toFixed(2)}`);
                }
            }

            // Shuffle incorrect definitions and pick 3
            shuffleArray(incorrectDefinitions);
            const distractors = incorrectDefinitions.slice(0, 3);

            // Combine correct definition with distractors
            let choices = [currentWord.definition, ...distractors];
            shuffleArray(choices); // Shuffle all choices

            currentWord.shuffledOptions = choices; // Store shuffled options for display

            wordDisplay.textContent = currentWord.word;
            wordDisplay.classList.remove('correct-feedback', 'wrong-feedback'); // Clear previous feedback
            displayChoices();
        }


        // Renders the choice buttons
        function displayChoices() {
            choicesContainer.innerHTML = ''; // Clear previous choices
            currentWord.shuffledOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.classList.add('choice-button', 'rounded-lg', 'text-sm', 'md:text-base');
                button.textContent = option;
                button.dataset.index = index; // Store index to identify choice
                button.addEventListener('click', () => checkAnswer(option));
                choicesContainer.appendChild(button);
            });
        }

        // Checks the player's answer
        function checkAnswer(selectedDefinition) {
            let isCorrect = false;
            if (selectedDefinition === currentWord.definition) {
                currentScore++;
                isCorrect = true;
                if (correctSound) correctSound.play().catch(e => console.error("Correct sound playback failed:", e));
            } else {
                wrongAttempts++;
                isCorrect = false;
                if (wrongSound) wrongSound.play().catch(e => console.error("Wrong sound playback failed:", e));
            }

            // Apply visual feedback
            if (isCorrect) {
                wordDisplay.classList.add('correct-feedback');
            } else {
                wordDisplay.classList.add('wrong-feedback');
            }

            updateScoreDisplay();

            setTimeout(() => {
                wordDisplay.classList.remove('correct-feedback', 'wrong-feedback');
                if (wrongAttempts >= 3) {
                    endGame();
                } else {
                    pickAndDisplayWord(); // Next word
                }
            }, 500); // 500ms delay for visual feedback
        }

        // Ends the game, shows final score, and prompts for name
        function endGame() {
            showScreen('game-over-screen');
            finalScoreDisplay.textContent = currentScore;
            playerNameInput.value = ''; // Clear input field
            saveScoreButton.disabled = false; // Enable save button
        }

        // --- Global Leaderboard Logic (Firestore) ---

        // Function to retry Firebase operations with exponential backoff
        async function retryFirebaseCall(fn, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (error.code === 'unavailable' || error.code === 'resource-exhausted' || error.code === 'aborted') {
                        console.warn(`Firebase call failed (${error.code}). Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw error; // Re-throw non-transient errors
                    }
                }
            }
            throw new Error(`Firebase call failed after ${retries} retries.`);
        }


        // Saves the current score to the global leaderboard
        async function saveScore() {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                showCustomModal("Oops!", "Please enter your name to save your score!");
                return;
            }

            // Explicitly check for Firebase readiness AND user ID before attempting save
            console.log("Save Score Attempt:");
            console.log("  firebaseInitialized:", window.firebaseInitialized);
            console.log("  db:", !!window.db); // Check if db object exists
            console.log("  addDoc:", !!window.addDoc); // Check if addDoc function exists
            console.log("  collection:", !!window.collection); // Check if collection function exists
            console.log("  currentUserId:", window.currentUserId); // Crucial: check if user is authenticated

            if (!window.firebaseInitialized || !window.db || !window.addDoc || !window.collection || !window.currentUserId) {
                console.warn("Save Score Aborted: Firebase or User not ready.");
                showCustomModal("Error", "Leaderboard service not ready. Please wait a moment and try again.");
                saveScoreButton.disabled = false; // Ensure button isn't stuck disabled
                return;
            }

            saveScoreButton.disabled = true; // Disable to prevent multiple submissions

            try {
                // Add score to Firestore
                await retryFirebaseCall(() => window.addDoc(window.collection(window.db, `artifacts/${window.appId}/public/data/globalLeaderboard`), {
                    name: playerName,
                    score: currentScore,
                    timestamp: window.serverTimestamp(), // Use server timestamp for consistent ordering
                    userId: window.currentUserId // Store user ID (should now be guaranteed to exist)
                }));
                showCustomModal("Score Saved!", "Your score has been added to the global leaderboard!");
                displayGlobalLeaderboard(); // Refresh leaderboard display
                showScreen('leaderboard-screen');
            } catch (e) {
                console.error("Error saving score to Firestore:", e);
                showCustomModal("Save Error", `Could not save score: ${e.message}`);
                saveScoreButton.disabled = false; // Re-enable on error
            }
        }

        // Displays the global leaderboard table
        window.loadGlobalLeaderboard = function() { // Made global so Firebase script can call it
            leaderboardLoading.classList.remove('hidden'); // Show loading indicator
            leaderboardBody.innerHTML = ''; // Clear previous entries

            if (!window.firebaseInitialized || !window.db || !window.collection || !window.query || !window.orderBy || !window.onSnapshot) {
                leaderboardBody.innerHTML = '<tr><td colspan="3">Leaderboard service not available.</td></tr>';
                leaderboardLoading.classList.add('hidden');
                return;
            }

            const q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/globalLeaderboard`),
                window.orderBy('score', 'desc')
                // You can add .limit(10) here if you want only top 10 from Firestore,
                // but for now we fetch all and slice in memory to allow flexible display.
            );

            // Listen for real-time updates to the leaderboard
            window.onSnapshot(q, (querySnapshot) => {
                leaderboardLoading.classList.add('hidden'); // Hide loading indicator
                const scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                // Sort and limit in memory (if not limited by query)
                scores.sort((a, b) => b.score - a.score);
                globalLeaderboardData = scores.slice(0, 10); // Keep top 10 for display

                leaderboardBody.innerHTML = ''; // Clear previous entries
                if (globalLeaderboardData.length === 0) {
                    leaderboardBody.innerHTML = '<tr><td colspan="3">No scores yet! Be the first!</td></tr>';
                    return;
                }

                globalLeaderboardData.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${entry.name}</td>
                        <td>${entry.score}</td>
                    `;
                    leaderboardBody.appendChild(row);
                });
            }, (error) => {
                console.error("Error fetching global leaderboard:", error);
                leaderboardLoading.classList.add('hidden');
                leaderboardBody.innerHTML = '<tr><td colspan="3">Error loading leaderboard.</td></tr>';
                showCustomModal("Leaderboard Error", "Could not load global leaderboard. Check your internet connection.");
            });
        }


        // Displays the leaderboard screen (this just switches screens, data is loaded by onSnapshot)
        function displayGlobalLeaderboard() {
            showScreen('leaderboard-screen');
            // Data loading is handled by the onSnapshot listener triggered by loadGlobalLeaderboard()
            // which is called when Firebase is initialized or when leaderboard screen is activated.
        }


        // --- Download Leaderboard Function (now downloads global data) ---
        function downloadLeaderboard() {
            if (globalLeaderboardData.length === 0) {
                showCustomModal("No Data", "Leaderboard is empty to download.");
                return;
            }
            const leaderboardDataString = JSON.stringify(globalLeaderboardData, null, 2); // Pretty print JSON
            const blob = new Blob([leaderboardDataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'word_war_gre_global_leaderboard.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up
        }

        // --- Music Control ---
        function toggleMusic() {
            if (musicPlaying) {
                backgroundMusic.pause();
                toggleMusicButton.textContent = "Play Music";
                musicPlaying = false;
            } else {
                backgroundMusic.volume = 0.5; // Set volume
                backgroundMusic.play().then(() => {
                    toggleMusicButton.textContent = "Pause Music";
                    musicPlaying = true;
                }).catch(e => {
                    console.error("Music playback failed:", e);
                    showCustomModal("Music Error", "Autoplay blocked. Please interact with the page first or try again.");
                });
            }
        }

        // --- Event Listeners ---
        window.onload = function() {
            // Attempt to autoplay music (subject to browser policies)
            backgroundMusic.volume = 0.5;
            backgroundMusic.play().then(() => {
                musicPlaying = true;
                toggleMusicButton.textContent = "Pause Music";
            }).catch(e => {
                musicPlaying = false;
                toggleMusicButton.textContent = "Play Music";
                console.error("Autoplay music failed:", e);
                showCustomModal("Music Blocked", "Your browser blocked automatic music playback. Click 'Toggle Music' to enable it.");
            });
            // Initial call to load leaderboard (will wait for Firebase to initialize)
            window.loadGlobalLeaderboard();
        };

        // Main Menu Buttons
        playSoloButton.addEventListener('click', startGame);
        showLeaderboardMainMenuButton.addEventListener('click', displayGlobalLeaderboard); // Changed to global
        toggleMusicButton.addEventListener('click', toggleMusic);

        // Game Over Buttons
        saveScoreButton.addEventListener('click', saveScore);
        playAgainButton.addEventListener('click', startGame);
        mainMenuFromGameOverButton.addEventListener('click', () => showScreen('main-menu'));

        // Leaderboard Button
        downloadLeaderboardButton.addEventListener('click', downloadLeaderboard);
        mainMenuFromLeaderboardButton.addEventListener('click', () => showScreen('main-menu'));

        // Custom Modal Close Button
        modalCloseButton.addEventListener('click', hideCustomModal);
    </script>
</body>
</html>
